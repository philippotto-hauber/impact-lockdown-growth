---
title: "Covid-19 lockdown measures and GDP growth"
output: html_notebook
---

# Housekeeping & packages

```{r}
rm(list = ls())
cat("\014")
options(scipen = 999)
library(bundesbank)
library(rdbnomics)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(readr) # parse_double
library(ggrepel)
library(forcats)
library(wbstats)
```

# GDP growth in H1

## DBnomics

### Eurostat

```{r}

codes_eurostat <- c("DE",
                    "BE",
                    "FR",
                    "IT",
                    "ES",
                    "IE",
                    "AT",
                    "DK",
                    "EL",
                    "FI",
                    "HU",
                    "CZ",
                    "PL",
                    "PT",
                    "SE",
                    "NL",
                    "SI")

countries_eurostat <- c("Germany",
                        "Belgium",
                        "France",
                        "Italy",
                        "Spain",
                        "Ireland",
                        "Austria",
                        "Denmark",
                        "Greece",
                        "Finland",
                        "Hungary",
                        "Czech Republic",
                        "Poland",
                        "Portugal",
                        "Sweden",
                        "Netherlands",
                        "Slovenia")

# initialize empty dataframe
df <- data.frame()

for (i in seq_along(codes_eurostat))
{
  
    rdb(provider_code = paste0("Eurostat/teina011/Q.B1GQ.PCH_Q1_SCA.", codes_eurostat[i])) %>%
                        filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
                        mutate(original_value = parse_double(original_value)) %>%
                        select(original_value, `Geopolitical entity (reporting)`) -> tmp2
    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(country = countries_eurostat[i], gdpH1 = gdpH1))
}
```

### OECD

```{r}
codes_oecd <- c("AUS",
                "BRA",
                "CAN",
                "CHL",
                "COL",
                "IND",
                "IDN",
                "ISR",
                "JPN",
                "KOR",
                "MEX",
                "GBR",
                "USA",
                "TUR",
                "CHE")

countries_oecd <- c("Australia",
                    "Brazil",
                    "Canada",
                    "Chile",
                    "Colombia",
                    "India",
                    "Indonesia",
                    "Israel",
                    "Japan",
                    "South Korea",
                    "Mexico",
                    "United Kingdom",
                    "United States",
                    "Turkey",
                    "Switzerland")

for (i in seq_along(codes_oecd))
{
  
    rdb(provider_code = paste0("OECD/MEI/", codes_oecd[i], ".NAEXKP01.GPSA.Q")) %>%
      filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
      mutate(original_value = parse_double(original_value)) %>%
      select(original_value, Country) -> tmp2

    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(country = countries_oecd[i], gdpH1 = gdpH1))
}
```

## Bundesbank


```{r}
codes_Bbk <- c("BBXN1.Q.CN.S.NAG.B1QG00.0000.Z0N.PER.I00",
               "BBXN1.Q.RU00.S.NAG.B1QG00.0000.Z0N.CPC.I00")

countries_Bbk <- c("China", "Russia")

for (i in seq_along(codes_Bbk))
{
  if (countries_Bbk[i] == "China") # China already in q/q growth rate!
  {
      tmp <- getSeries(codes_Bbk[i], start = "2020-01", end = "2020-06")


      gdpH1 <- 100 * (1+tmp[1, 2]/100) * (1+tmp[2, 2]/100) - 100
      df <- rbind(df, data.frame(country = countries_Bbk[i],
                                 gdpH1 = gdpH1))

}
  else
  {
      tmp <- getSeries(codes_Bbk[i], start = "2019-09", end = "2020-06")
      #tmp$values <- parse_double(tmp$values)
      gdpH1 <- tmp[3, 2] / tmp[1, 2] * 100 - 100
      df <- rbind(df, data.frame(country = countries_Bbk[i],
                                 gdpH1 = gdpH1))
  }
}
```


# Stringency index

## Load raw data and select the relevant indicators

```{r}
rawdata_string <- read.csv("https://github.com/OxCGRT/covid-policy-tracker/raw/master/data/OxCGRT_latest.csv")


df_string <- rawdata_string %>% 
             mutate(Date = ymd(Date),
                    CountryName = CountryName,
                    StringencyIndex = StringencyIndex) %>% 
             select(CountryName, StringencyIndex, Date) 
```

## Calculate average index value for 2020H1

```{r}
df_string_avgH1 <- df_string %>% 
                   filter(Date <= "2020-06-30") %>%
                   group_by(CountryName) %>%
                   summarise(stringency = mean(StringencyIndex))
```

Merge with GDP growth in 2020H1
```{r}
df <- merge(df, df_string_avgH1, by.x = "country", by.y = "CountryName")
```


# October 2019 WEO

```{r}
GetWEOData <- function(filename, year, var, rename_col)
{
  require(dplyr)
  require(readr)
  tmp <- read_delim(filename, delim = ";") %>%
         select(country = Country, iso = ISO, variable = "WEO Subject Code", val = !!year) %>%
         filter(variable == !!var) %>%
         select(-variable, everything()) %>%
         filter(val != "n/a") %>%
         mutate(val = parse_double(val)) %>%
         select(country, iso, !!rename_col := val)
  return(tmp)
}

filename <- "WEOOct2019all.csv"

weo <- GetWEOData(filename, year = "2020", var = "NGDP_RPCH", rename_col = "gdp_Oct19WEO")

```

Rename Korea, drop iso

```{r}
weo$country[weo$country == "Korea"] <- "South Korea"

weo <- select(weo, -iso)
```

Recalculate growth rate for 2020 to correspond to 2020H1 (i.e. de-annualize)

```{r}
weo$gdp_Oct19WEO  <- (1 + weo$gdp_Oct19WEO / 100) ^ 0.5 * 100 - 100
```

Merge with `df`

```{r}
df <- merge(df, weo, by = "country")
```

Create new variable: deviation from IMF WEO forecast and remove WEO forecast
```{r}
df <- df %>% mutate(dev_gdp = gdpH1 - gdp_Oct19WEO) %>% 
             select(-gdp_Oct19WEO)
```

# Openness

Sum of exports and imports in relation to GDP. Source: IMF International Financial Statistics

```{r}
mnemonics_IFS <- c("DE",
                    "BE",
                    "FR",
                    "IT",
                    "ES",
                    "IE",
                    "AT",
                    "DK",
                    "GR",
                    "FI",
                    "HU",
                    "CZ",
                    "PL",
                    "PT",
                    "SE",
                    "NL",
                    "SI",
                    "GB",
                    "US",
                    "JP",
                    "KR", 
                    "AU",
                    "CH",
                    "CA",
                    "IL",
                    "CN",
                    "RU",
                    "IN",
                    "ID",
                    "TR",
                    "BR",
                    "CL",
                    "CO",
                    "MX")

countries_IFS <- c("Germany",
                        "Belgium",
                        "France",
                        "Italy",
                        "Spain",
                        "Ireland",
                        "Austria",
                        "Denmark",
                        "Greece",
                        "Finland",
                        "Hungary",
                        "Czech Republic",
                        "Poland",
                        "Portugal",
                        "Sweden",
                        "Netherlands",
                        "Slovenia", 
                        "United Kingdom",
                        "United States",
                        "Japan",
                        "South Korea",
                        "Australia", 
                        "Switzerland",
                        "Canada",
                        "Israel",
                        "China", 
                        "Russia",
                        "India",
                        "Indonesia",
                        "Turkey",
                        "Brazil",
                        "Chile",
                        "Colombia",
                        "Mexico")

vars <- c("NGDP", "NX", "NM")
ifs <- data.frame()
for (i in seq_along(countries_IFS))
{
  codes <- paste0("IMF/IFS/A.", mnemonics_IFS[i], ".", vars, "_XDC")
  tmp <- rdb(provider_code = codes)
  if (countries_IFS[i] %in% c("Brazil", "China", "Israel")) # no data for 2019!
    tmp2 <- filter(tmp, original_period == 2018) %>% mutate(original_value = as.numeric(original_value))
  else
    tmp2 <- filter(tmp, original_period == 2019) %>% mutate(original_value = as.numeric(original_value))
  
  tmp3 <- (tmp2[tmp2$INDICATOR == "NX_XDC", "original_value"] + 
             tmp2[tmp2$INDICATOR == "NM_XDC", "original_value"]) / 
              tmp2[tmp2$INDICATOR == "NGDP_XDC", "original_value"] * 100
  ifs <- rbind(ifs, data.frame(country = countries_IFS[i], openness = as.numeric(tmp3)))
}
```

Merge with `df`

```{r}
df <- merge(df, ifs, by = "country")
```

# Tourism 

As a share of GDP. Source: World Bank (WDI?)

```{r}
wb_raw <- wb_data(country = "all", indicator = c("ST.INT.RCPT.CD", "NY.GDP.MKTP.CD"), start_date = 2018)
mnemonics_wb <- mnemonics_IFS
wb_raw %>% filter(date == "2018", iso2c %in% mnemonics_wb) %>% select(country, receipts = ST.INT.RCPT.CD, gdpusd = NY.GDP.MKTP.CD) %>%
mutate(tourism = receipts / gdpusd * 100) %>%
select(-c(receipts, gdpusd)) -> wb
wb$country[wb$country == "Russian Federation"] <- "Russia"
wb$country[wb$country == "Korea, Rep."] <- "South Korea"

```

Merge with `df` 
```{r}
df <- merge(df, wb, by = "country")
```


Alternative source: WTTC, data for travel and tourism value added. 

```{r}
wttc_raw <- read.csv(file = "WTTC.csv", sep = ";", stringsAsFactors = FALSE)

wttc_raw$Country[wttc_raw$Country == "Russian Federation"] <- "Russia"

wttc_raw %>% filter(Country %in% countries_IFS) %>% select(country = Country, traveltourism = X2018) -> wttc
```

Merge with `df` 
```{r}
df <- merge(df, wttc, by = "country")
```


# Covid-19 deaths

Cumulated deaths by end of 2020Q2. Source: ECDC

```{r}
ecdc_raw <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", 
                    na.strings = "", 
                    fileEncoding = "UTF-8-BOM", stringsAsFactors = FALSE)

# replace names
ecdc_raw$countriesAndTerritories[grep(pattern = "Czech+", ecdc_raw$countriesAndTerritories)] <- "Czech Republic"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "United_States_of_America"] <- "United States"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "United_Kingdom"] <- "United Kingdom"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "South_Korea"] <- "South Korea"

# calculate cumulated deaths per million inhabitants
ecdc_raw %>% mutate(date = make_date(year, month, day),
                    pop_mio = popData2019 / 1000000) %>% 
             select(country = countriesAndTerritories, date = date, cases, deaths, pop_mio) %>% 
             filter(country %in% countries_IFS) %>%
            arrange(date) %>%
            group_by(country) %>%
            mutate(cases_cumsum = cumsum(cases) / pop_mio,
                   deaths_cumsum = cumsum(deaths) / pop_mio) %>% 
            filter(date == "2020-06-30") %>% 
            select(country, covid19cases = cases_cumsum, covid19deaths = deaths_cumsum) -> ecdc
```

Merge with `df`

```{r}
df <- merge(df, ecdc, by= "country")
```


# Google mobility data

```{r}
google_raw <- read_csv(file ="https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

google_raw$country_region[grep(pattern = "Czech+", google_raw$country_region)] <- "Czech Republic"

google_raw %>% filter(is.na(sub_region_1)) %>% 
               select(date, 
                      country = country_region,
                      retail_rec = retail_and_recreation_percent_change_from_baseline,
                      transit = transit_stations_percent_change_from_baseline,
                      workplace = workplaces_percent_change_from_baseline) %>%
               filter(country %in% countries_IFS, date <= "2020-06-30") %>%
               group_by(country) %>%
               summarise(retail_rec = mean(retail_rec, na.rm = TRUE),
                         transit = mean(transit, na.rm = TRUE),
                         workplace = mean(workplace, na.rm = TRUE)) -> google
```

Merge with `df` and gather into `var` and `value`

```{r}
df <- merge(df, google, by = "country", all.x = TRUE) %>% gather(var, value, -c(country, gdpH1, dev_gdp))
```

# Plot

List of emerging market economies
```{r}
list_EME <- c("Brazil", "Mexico", "Turkey", 
              "China", "India", "Indonesia", 
              "Chile", "Colombia", "Turkey",
              "Poland", "Hungary", "Czech Republic")
```


## Plot stringency, openness, etc vs. GDP in 2020H1
```{r}
df %>% select(-c(dev_gdp)) %>% 
       filter(var %in% c("stringency", "openness", "traveltourism","tourism", "covid19cases", "covid19deaths"),
              country != "China") %>% 
       mutate(status = ifelse(country %in% list_EME, "Schwellenländer", "fortgeschrittene Volkswirtschaften"),
              var = fct_recode(var, "Lockdown-Stringenz" = "stringency", 
                                              "Offenheit" = "openness", 
                                              "Tourismus (WTTC)" = "traveltourism",
                                              "Tourismus (Weltbank)" = "tourism",
                                              "Covid-19-Infektionen" = "covid19cases",
                                              "Covid-19-Todesfälle" = "covid19deaths")
            ) %>%
       ggplot(aes(x = value, y = gdpH1))+
         geom_point()+
         geom_smooth(method = "lm", se = FALSE, color = "black", size = 0.5)+
         geom_point(aes(color = status), size = 3)+
         facet_wrap(~var, scales = "free_x")+
         labs(y = "BIP, Prozent", x = "",
              title = "Covid-19-Pandemie: wirtschaftliche Entwicklung in 2020H1",
              subtitle = "Zusammenhang mit Covid-19-Todesfällen, Grad der Offenheit, Lockdown-Stringenz und Bedeutung des Tourismus ",
              caption = paste0("Daten für ", length(unique(df$country)) - 1 , " Länder, BIP: Veränderung zwischen 2020Q2 und 2019Q4, Infektions- und Todesfälle: kumuliert, je 1 Mio. Einwohner, Stand 30.6.2020,\nOffenheit: Summe der Exporte und Importe im Verhältnis zur Wirtschaftsleistung,Tourismus (Weltbank): Einnahmen im Verhältnis zur Wirtschaftsleistung,\nTourismus (WTTC): Gesamtbeitrag zur Bruttowertschöpfung (Prozent),Lockdown-Stringenz: Index, Durchschnitt in 2020H1, höhere Werte = strengere Maßnahmen, \nschwarze Linie: linearer Trend.Quelle: OECD Main Economic Indicators, Deutsche Bundesbank, ECDC, IMF International Financial Statistics,\nHale et al. (2020), World Travel and Trade Council, Weltbank World Development Indicators."))+
        theme_minimal()+
        theme(legend.title = element_blank(), legend.position = "top", legend.text=element_text(size=9))
```

```{r}
ggsave(
  filename = "Abb_BIPH1_verschiedeneIndikatoren.pdf",
  plot = last_plot(),
  device = "pdf",
  path = NULL,
  scale = 1,
  width = 25,
  height = 20,
  units = c("cm"),
  dpi = 300,
  limitsize = TRUE,
)
```



## Google mobility data vs. GDP in 2020H1

```{r}
df %>% filter(var %in% c("retail_rec", "transit", "workplace"),
              country != "China") %>%
        mutate(status = ifelse(country %in% list_EME, "Schwellenländer", "fortgeschrittene Volkswirtschaften"),
               var = fct_recode(var, "retail and recreation" = "retail_rec", 
                                                    "transit stations" = "transit", 
                                                    "workplace" = "workplace"),
               value = value + 100
               ) %>%
  ggplot(aes(x = value, y = gdpH1, color = var))+
  geom_point(size = 3)+
  geom_smooth(method = "lm", se = FALSE)+
  theme_minimal()+
  theme(legend.title = element_blank(), legend.position = "top", legend.text=element_text(size=9))+
  labs(y = "BIP, Prozent", x = "Mobilitätsdaten, Durchschnitt 2020H1",
       title = "Covid-19-Pandemie: wirtschaftliche Entwicklung in 2020H1",
       subtitle = "Zusammenhang mit Google-Mobilitätsdaten ",
              caption = paste0("Daten für ", length(unique(df$country)) - 1 , " Länder, BIP: Veränderung zwischen 2020Q2 und 2019Q4, Mobilitätsdaten: Median zwischen 3. Januar und 6. Februar = 100.\n Linien: linearer Trend. Quelle: OECD Main Economic Indicators, Deutsche Bundesbank, Google Covid-19 Community Mobility Report."))
```

```{r}
ggsave(
  filename = "Abb_BIPH1_Google.pdf",
  plot = last_plot(),
  device = "pdf",
  path = NULL,
  scale = 1,
  width = 25,
  height = 20,
  units = c("cm"),
  dpi = 300,
  limitsize = TRUE,
)
```



