---
title: "Covid-19 lockdown measures and GDP growth"
output: html_notebook
---

# Housekeeping & packages

```{r}
rm(list = ls())
cat("\014")
options(scipen = 999)
library(bundesbank)
library(rdbnomics)
library(dplyr)
library(lubridate)
library(ggplot2)
library(readr) # parse_double
library(ggrepel)
library(forcats)
```

# GDP growth in Q1

## DBnomics

### Eurostat

```{r}

codes_eurostat <- c("DE",
                    "BE",
                    "FR",
                    "IT",
                    "ES",
                    "IE",
                    "AT",
                    "DK",
                    "EL",
                    "FI",
                    "HU",
                    "CZ",
                    "PL",
                    "PT",
                    "SE",
                    "NL",
                    "SI")

countries_eurostat <- c("Germany",
                        "Belgium",
                        "France",
                        "Italy",
                        "Spain",
                        "Ireland",
                        "Austria",
                        "Denmark",
                        "Greece",
                        "Finland",
                        "Hungary",
                        "Czech Republic",
                        "Poland",
                        "Portugal",
                        "Sweden",
                        "Netherlands",
                        "Slovenia")

# initialize empty dataframe
df <- data.frame()

for (i in seq_along(codes_eurostat))
{
  
    rdb(provider_code = paste0("Eurostat/teina011/Q.B1GQ.PCH_Q1_SCA.", codes_eurostat[i])) %>%
                        filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
                        mutate(original_value = parse_double(original_value)) %>%
                        select(original_value, `Geopolitical entity (reporting)`) -> tmp2
    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(gdpH1 = gdpH1, country = countries_eurostat[i]))
}
```

### OECD

```{r}
codes_oecd <- c("AUS",
                "BRA",
                "CAN",
                "CHL",
                "COL",
                "IND",
                "IDN",
                "ISR",
                "JPN",
                "KOR",
                "MEX",
                "GBR",
                "USA",
                "TUR",
                "CHE")

countries_oecd <- c("Australia",
                    "Brazil",
                    "Canada",
                    "Chile",
                    "Colombia",
                    "India",
                    "Indonesia",
                    "Israel",
                    "Japan",
                    "South Korea",
                    "Mexico",
                    "United Kingdom",
                    "United States",
                    "Turkey",
                    "Switzerland")

for (i in seq_along(codes_oecd))
{
  
    rdb(provider_code = paste0("OECD/MEI/", codes_oecd[i], ".NAEXKP01.GPSA.Q")) %>%
      filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
      mutate(original_value = parse_double(original_value)) %>%
      select(original_value, Country) -> tmp2
  
    if (countries_oecd[i] == "India")
      tmp2 <- rbind(tmp2, data.frame(original_value = -25.0, Country = "India"))
  
    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(gdpH1 = gdpH1, country = countries_oecd[i]))
}
```

## Bundesbank


```{r}
codes_Bbk <- c("BBXN1.Q.CN.S.NAG.B1QG00.0000.Z0N.PER.I00",
               "BBXN1.Q.RU00.S.NAG.B1QG00.0000.Z0N.CPC.I00")

countries_Bbk <- c("China", "Russia")

for (i in seq_along(codes_Bbk))
{
  if (countries_Bbk[i] == "China") # China already in q/q growth rate!
  {
      tmp <- getSeries(codes_Bbk[i], start = "2020-01", end = "2020-06")


      gdpH1 <- 100 * (1+tmp[1, 2]/100) * (1+tmp[2, 2]/100) - 100
      df <- rbind(df, data.frame(gdpH1 = gdpH1,
                             country = countries_Bbk[i]))

}
  else
  {
      tmp <- getSeries(codes_Bbk[i], start = "2019-09", end = "2020-06")
      #tmp$values <- parse_double(tmp$values)
      gdpH1 <- tmp[3, 2] / tmp[1, 2] * 100 - 100
      df <- rbind(df, data.frame(gdpH1 = gdpH1,
                                 country = countries_Bbk[i]))
  }
}
```


# Stringency index

## Load raw data and select the relevant indicators

```{r}
rawdata_string <- read.csv("https://github.com/OxCGRT/covid-policy-tracker/raw/master/data/OxCGRT_latest.csv")


df_string <- rawdata_string %>% 
             mutate(Date = ymd(Date)) %>% 
             select(CountryName, ConfirmedDeaths, StringencyIndex, Date) 
```

## Calculate average index value for 2020H1

```{r}
df_string_avgH1 <- df_string %>% 
                   filter(Date <= "2020-06-30") %>%
                   group_by(CountryName) %>%
                   summarise(avgH1 = mean(StringencyIndex))
```

# October 2019 WEO

```{r}
GetWEOData <- function(filename, year, var, rename_col)
{
  require(dplyr)
  require(readr)
  tmp <- read_delim(filename, delim = ";") %>%
         select(country = Country, iso = ISO, variable = "WEO Subject Code", val = !!year) %>%
         filter(variable == !!var) %>%
         select(-variable, everything()) %>%
         filter(val != "n/a") %>%
         mutate(val = parse_double(val)) %>%
         select(country, iso, !!rename_col := val)
  return(tmp)
}

filename <- "WEOOct2019all.csv"

weo <- GetWEOData(filename, year = "2020", var = "NGDP_RPCH", rename_col = "gdp_Oct19")

```


# Analysis

## Merge GDP growth in 2020H1 and average stringency index

```{r}
df <- merge(df, df_string_avgH1, by.x = "country", by.y = "CountryName")
```

Merge with IMF forecast

```{r}
df <- merge(df, weo, by = "country")
```

Create new variable: deviation from IMF WEO forecast
```{r}
df$dev_gdp <- df$gdpH1 - df$gdp_Oct19
```


## Plot

### stringency index vs. GDP growth in H1

```{r, fig.height = 5, fig.width = 8}

ggplot(data = df, aes(x = avgH1, y = gdpH1))+
  geom_point()+
  geom_point(data = filter(df, country %in%  c("Italy", "China", "Sweden", "South Korea", "Germany")),
                   aes(x = avgH1, y = gdpH1), color = "red")+
  geom_label(data = filter(df, country %in%  c("Italy", "China", "Sweden", "South Korea")),
                   aes(label = country),
                   nudge_x = 1.5, nudge_y = 1.7, size = 3)+
    geom_label(data = filter(df, country %in%  c("Germany")),
                   aes(label = country),
                   nudge_x = 2.0, nudge_y = -2.0, size = 3)+
  scale_x_continuous(breaks = seq(0, 60, 10))+
  labs(x = "index",
       y = "percent",
       title = "Lockdown measures and economic activity",
       subtitle = "Average stringency index vs. GDP growth in the first half of 2020",
       caption = paste0("Data for ", nrow(df), " advanced and emerging economies.\nStringency index:higher values indicate more stringent lockdown measures,\nGDP: price and seasonally adjusted, percent change in the level of GDP between 2019Q4 and 2020Q2. \n Source: Hale, Thomas, Sam Webster, Anna Petherick, Toby Phillips and Beatriz Kira (2020); \nEurostat, OECD, national statistical authorities."))
```

Save figure to png
```{r}
ggsave(
  filename = "plot_H1.png",
  plot = last_plot(),
  device = "png",
  path = NULL,
  scale = 1,
  width = 20,
  height = 15,
  units = c("cm")
)
```

### stringency index vs deviation from IMF October 2019 WEO forecast

```{r}
ggplot(data = df, aes(x = avgH1, y = dev_gdp))+
  geom_point()+
  geom_point(data = filter(df, country %in%  c("Italy", "China", "Sweden", "India", "Germany")),
                   aes(x = avgH1, y = dev_gdp), color = "red")+
  geom_label(data = filter(df, country %in%  c("Italy", "China", "Sweden", "India")),
                   aes(label = country),
                   nudge_x = 1, nudge_y = 1.5, size = 3)+
  geom_label(data = filter(df, country %in%  c("Germany")),
                   aes(label = country),
                   nudge_x = 2, nudge_y = 3, size = 3)+
  scale_x_continuous(limits = c(20, 70), breaks = seq(0, 60, 10))+
  scale_y_continuous(limits = c(-35, 0), breaks = seq(0, -40, -10))+
  labs(x = "index",
       y = "percentage points",
       title = "Lockdown measures and economic activity",
       subtitle = "Average stringency index vs. drop in GDP compared to IMF forecast",
       caption = paste0("Data for ", nrow(df), " advanced and emerging economies.\nStringency index:higher values indicate more stringent lockdown measures,\ndrop in GDP is measured as the difference of 2020H1 growth from the IMF October 2019 WEO forecast. \n Source: Hale, Thomas, Sam Webster, Anna Petherick, Toby Phillips and Beatriz Kira (2020); \nEurostat, OECD, national statistical authorities."))
```

Save figure to png
```{r}
ggsave(
  filename = "plot_H1vsWEO.png",
  plot = last_plot(),
  device = "png",
  path = NULL,
  scale = 1,
  width = 20,
  height = 15,
  units = c("cm")
)
```

## Export data to xlsx

```{r}
library(xlsx)

df_out <- df %>% select(country, avgH1, gdpH1)
write.xlsx(df_out, "data_plot_avgIndex_gdp.xlsx")

df_out <- df %>% select(country, avgH1, gdpH1)
write.xlsx(df_out, "data_plot_avgIndex_gdp_rel_WEO.xlsx")
```


