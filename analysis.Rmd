---
title: "Covid-19 lockdown measures and GDP growth"
output: html_notebook
---

# Housekeeping & packages

```{r}
rm(list = ls())
cat("\014")
options(scipen = 999)
library(bundesbank)
library(rdbnomics)
library(dplyr)
library(tidyr)
library(lubridate)
library(ggplot2)
library(readr) # parse_double
library(ggrepel)
library(forcats)
library(wbstats)
```

# GDP growth in H1

## DBnomics

### Eurostat

```{r}

codes_eurostat <- c("DE",
                    "BE",
                    "FR",
                    "IT",
                    "ES",
                    "IE",
                    "AT",
                    "DK",
                    "EL",
                    "FI",
                    "HU",
                    "CZ",
                    "PL",
                    "PT",
                    "SE",
                    "NL",
                    "SI")

countries_eurostat <- c("Germany",
                        "Belgium",
                        "France",
                        "Italy",
                        "Spain",
                        "Ireland",
                        "Austria",
                        "Denmark",
                        "Greece",
                        "Finland",
                        "Hungary",
                        "Czech Republic",
                        "Poland",
                        "Portugal",
                        "Sweden",
                        "Netherlands",
                        "Slovenia")

# initialize empty dataframe
df <- data.frame()

for (i in seq_along(codes_eurostat))
{
  
    rdb(provider_code = paste0("Eurostat/teina011/Q.B1GQ.PCH_Q1_SCA.", codes_eurostat[i])) %>%
                        filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
                        mutate(original_value = parse_double(original_value)) %>%
                        select(original_value, `Geopolitical entity (reporting)`) -> tmp2
    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(country = countries_eurostat[i], gdpH1 = gdpH1))
}
```

### OECD

```{r}
codes_oecd <- c("AUS",
                "BRA",
                "CAN",
                "CHL",
                "COL",
                "IND",
                "IDN",
                "ISR",
                "JPN",
                "KOR",
                "MEX",
                "GBR",
                "USA",
                "TUR",
                "CHE")

countries_oecd <- c("Australia",
                    "Brazil",
                    "Canada",
                    "Chile",
                    "Colombia",
                    "India",
                    "Indonesia",
                    "Israel",
                    "Japan",
                    "South Korea",
                    "Mexico",
                    "United Kingdom",
                    "United States",
                    "Turkey",
                    "Switzerland")

for (i in seq_along(codes_oecd))
{
  
    rdb(provider_code = paste0("OECD/MEI/", codes_oecd[i], ".NAEXKP01.GPSA.Q")) %>%
      filter(original_period %in% c("2020-Q1", "2020-Q2")) %>%
      mutate(original_value = parse_double(original_value)) %>%
      select(original_value, Country) -> tmp2

    gdpH1 <- 100 * (1+tmp2$original_value[1]/100) * (1+tmp2$original_value[2]/100) - 100
    df <- rbind(df, data.frame(country = countries_oecd[i], gdpH1 = gdpH1))
}
```

## Bundesbank


```{r}
codes_Bbk <- c("BBXN1.Q.CN.S.NAG.B1QG00.0000.Z0N.PER.I00",
               "BBXN1.Q.RU00.S.NAG.B1QG00.0000.Z0N.CPC.I00")

countries_Bbk <- c("China", "Russia")

for (i in seq_along(codes_Bbk))
{
  if (countries_Bbk[i] == "China") # China already in q/q growth rate!
  {
      tmp <- getSeries(codes_Bbk[i], start = "2020-01", end = "2020-06")


      gdpH1 <- 100 * (1+tmp[1, 2]/100) * (1+tmp[2, 2]/100) - 100
      df <- rbind(df, data.frame(country = countries_Bbk[i],
                                 gdpH1 = gdpH1))

}
  else
  {
      tmp <- getSeries(codes_Bbk[i], start = "2019-09", end = "2020-06")
      #tmp$values <- parse_double(tmp$values)
      gdpH1 <- tmp[3, 2] / tmp[1, 2] * 100 - 100
      df <- rbind(df, data.frame(country = countries_Bbk[i],
                                 gdpH1 = gdpH1))
  }
}
```


# Stringency index

## Load raw data and select the relevant indicators

```{r}
rawdata_string <- read.csv("https://github.com/OxCGRT/covid-policy-tracker/raw/master/data/OxCGRT_latest.csv")


df_string <- rawdata_string %>% 
             mutate(Date = ymd(Date),
                    CountryName = CountryName,
                    StringencyIndex = StringencyIndex) %>% 
             select(CountryName, StringencyIndex, Date) 
```

## Calculate average index value for 2020H1

```{r}
df_string_avgH1 <- df_string %>% 
                   filter(Date <= "2020-06-30") %>%
                   group_by(CountryName) %>%
                   summarise(stringency = mean(StringencyIndex))
```

Merge with GDP growth in 2020H1
```{r}
df <- merge(df, df_string_avgH1, by.x = "country", by.y = "CountryName")
```


# October 2019 WEO

```{r}
GetWEOData <- function(filename, year, var, rename_col)
{
  require(dplyr)
  require(readr)
  tmp <- read_delim(filename, delim = ";") %>%
         select(country = Country, iso = ISO, variable = "WEO Subject Code", val = !!year) %>%
         filter(variable == !!var) %>%
         select(-variable, everything()) %>%
         filter(val != "n/a") %>%
         mutate(val = parse_double(val)) %>%
         select(country, iso, !!rename_col := val)
  return(tmp)
}

filename <- "WEOOct2019all.csv"

weo <- GetWEOData(filename, year = "2020", var = "NGDP_RPCH", rename_col = "gdp_Oct19WEO")

```

Rename Korea, drop iso

```{r}
weo$country[weo$country == "Korea"] <- "South Korea"

weo <- select(weo, -iso)
```

Recalculate growth rate for 2020 to correspond to 2020H1 (i.e. de-annualize)

```{r}
weo$gdp_Oct19WEO  <- (1 + weo$gdp_Oct19WEO / 100) ^ 0.5 * 100 - 100
```

Merge with `df`

```{r}
df <- merge(df, weo, by = "country")
```

Create new variable: deviation from IMF WEO forecast
```{r}
df$dev_gdp <- df$gdpH1 - df$gdp_Oct19WEO
```

# Openness

Sum of exports and imports in relation to GDP. Source: IMF International Financial Statistics

```{r}
mnemonics_IFS <- c("DE",
                    "BE",
                    "FR",
                    "IT",
                    "ES",
                    "IE",
                    "AT",
                    "DK",
                    "GR",
                    "FI",
                    "HU",
                    "CZ",
                    "PL",
                    "PT",
                    "SE",
                    "NL",
                    "SI",
                    "GB",
                    "US",
                    "JP",
                    "KR", 
                    "AU",
                    "CH",
                    "CA",
                    "IL",
                    "CN",
                    "RU",
                    "IN",
                    "ID",
                    "TR",
                    "BR",
                    "CL",
                    "CO",
                    "MX")

countries_IFS <- c("Germany",
                        "Belgium",
                        "France",
                        "Italy",
                        "Spain",
                        "Ireland",
                        "Austria",
                        "Denmark",
                        "Greece",
                        "Finland",
                        "Hungary",
                        "Czech Republic",
                        "Poland",
                        "Portugal",
                        "Sweden",
                        "Netherlands",
                        "Slovenia", 
                        "United Kingdom",
                        "United States",
                        "Japan",
                        "South Korea",
                        "Australia", 
                        "Switzerland",
                        "Canada",
                        "Israel",
                        "China", 
                        "Russia",
                        "India",
                        "Indonesia",
                        "Turkey",
                        "Brazil",
                        "Chile",
                        "Colombia",
                        "Mexico")

vars <- c("NGDP", "NX", "NM")
ifs <- data.frame()
for (i in seq_along(countries_IFS))
{
  codes <- paste0("IMF/IFS/A.", mnemonics_IFS[i], ".", vars, "_XDC")
  tmp <- rdb(provider_code = codes)
  if (countries_IFS[i] %in% c("Brazil", "China", "Israel")) # no data for 2019!
    tmp2 <- filter(tmp, original_period == 2018) %>% mutate(original_value = as.numeric(original_value))
  else
    tmp2 <- filter(tmp, original_period == 2019) %>% mutate(original_value = as.numeric(original_value))
  
  tmp3 <- (tmp2[tmp2$INDICATOR == "NX_XDC", "original_value"] + 
             tmp2[tmp2$INDICATOR == "NM_XDC", "original_value"]) / 
              tmp2[tmp2$INDICATOR == "NGDP_XDC", "original_value"] * 100
  ifs <- rbind(ifs, data.frame(country = countries_IFS[i], openness = as.numeric(tmp3)))
}
```

Merge with `df`

```{r}
df <- merge(df, ifs, by = "country")
```

# Tourism 

As a share of total exports. Source: World Bank (WDI?)

```{r}
wb_raw <- wb(country = "all", indicator = "ST.INT.RCPT.XP.ZS")
mnemonics_wb <- mnemonics_IFS
wb_raw %>% filter(date == "2018", iso2c %in% mnemonics_wb) %>% select(country, tourism = value) -> wb
wb$country[wb$country == "Russian Federation"] <- "Russia"
wb$country[wb$country == "Korea, Rep."] <- "South Korea"
```

Merge with `df` 
```{r}
df <- merge(df, wb, by = "country")
```

# Covid-19 deaths

Cumulated deaths by end of 2020Q2. Source: ECDC

```{r}
ecdc_raw <- read.csv("https://opendata.ecdc.europa.eu/covid19/casedistribution/csv", 
                    na.strings = "", 
                    fileEncoding = "UTF-8-BOM", stringsAsFactors = FALSE)

# replace names
ecdc_raw$countriesAndTerritories[grep(pattern = "Czech+", ecdc_raw$countriesAndTerritories)] <- "Czech Republic"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "United_States_of_America"] <- "United States"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "United_Kingdom"] <- "United Kingdom"
ecdc_raw$countriesAndTerritories[ecdc_raw$countriesAndTerritories == "South_Korea"] <- "South Korea"

# calculate cumulated deaths per million inhabitants
ecdc_raw %>% mutate(date = make_date(year, month, day),
                    pop_mio = popData2019 / 1000000) %>% 
             select(country = countriesAndTerritories, date = date, deaths, pop_mio) %>% 
             filter(country %in% countries_IFS) %>%
            arrange(date) %>%
            group_by(country) %>%
            mutate(deaths_cumsum = cumsum(deaths) / pop_mio) %>% 
            filter(date == "2020-06-30") %>% 
            select(country, covid19deaths = deaths_cumsum) -> ecdc
```

Merge with `df`

```{r}
df <- merge(df, ecdc, by= "country")
```


# Google mobility data

```{r}
google_raw <- read_csv(file ="https://www.gstatic.com/covid19/mobility/Global_Mobility_Report.csv")

google_raw$country_region[grep(pattern = "Czech+", google_raw$country_region)] <- "Czech Republic"

google_raw %>% filter(is.na(sub_region_1)) %>% 
               select(date, 
                      country = country_region,
                      mobility = retail_and_recreation_percent_change_from_baseline) %>%
               filter(country %in% countries_IFS, date <= "2020-06-30") %>%
               group_by(country) %>%
               summarise(avg_mobility = mean(mobility, na.rm = TRUE)) -> google
```

Merge with `df`, no observation for China

```{r}
df <- merge(df, google, by = "country")
```

# Plot

```{r}
df2 <- df %>% select(-c(gdpH1, gdp_Oct19WEO)) %>% gather(variable, value, -c("dev_gdp", "country"))

ggplot(filter(df2, country != "China"), aes(x = value, y = dev_gdp))+geom_point()+geom_smooth(method = "lm", se = FALSE)+facet_wrap(~variable, scales = "free_x")
```


### stringency index vs. GDP growth in H1

```{r, fig.height = 5, fig.width = 8}

ggplot(data = df, aes(x = avgH1, y = gdpH1))+
  geom_point()+
  geom_point(data = filter(df, country %in%  c("Italy", "China", "Sweden", "South Korea", "Germany")),
                   aes(x = avgH1, y = gdpH1), color = "red")+
  geom_label(data = filter(df, country %in%  c("Italy", "China", "Sweden", "South Korea")),
                   aes(label = country),
                   nudge_x = 1.5, nudge_y = 1.7, size = 3)+
    geom_label(data = filter(df, country %in%  c("Germany")),
                   aes(label = country),
                   nudge_x = 2.0, nudge_y = -2.0, size = 3)+
  scale_x_continuous(breaks = seq(0, 60, 10))+
  labs(x = "index",
       y = "percent",
       title = "Lockdown measures and economic activity",
       subtitle = "Average stringency index vs. GDP growth in the first half of 2020",
       caption = paste0("Data for ", nrow(df), " advanced and emerging economies.\nStringency index:higher values indicate more stringent lockdown measures,\nGDP: price and seasonally adjusted, percent change in the level of GDP between 2019Q4 and 2020Q2. \n Source: Hale, Thomas, Sam Webster, Anna Petherick, Toby Phillips and Beatriz Kira (2020); \nEurostat, OECD, national statistical authorities."))
```

Save figure to png
```{r}
ggsave(
  filename = "plot_H1.png",
  plot = last_plot(),
  device = "png",
  path = NULL,
  scale = 1,
  width = 20,
  height = 15,
  units = c("cm")
)
```

Regression (excluding China)

```{r}
reg_exchina <- lm(gdpH1 ~ avgH1, data = df[df$country != "China",])
summary(reg_exchina)
```

Plot along with data points

```{r}
ggplot(data = df, aes(x = avgH1, y = gdpH1))+
  geom_point()+
  geom_abline(intercept = coefficients(reg_exchina)[1], slope = coefficients(reg_exchina)[2])+
  scale_x_continuous(breaks = seq(0, 60, 10))+
  labs(x = "index",
       y = "percent",
       title = "Lockdown measures and economic activity",
       subtitle = "Average stringency index vs. GDP growth in the first half of 2020",
       caption = paste0("Data for ", nrow(df), " advanced and emerging economies.\nStringency index:higher values indicate more stringent lockdown measures,\nGDP: price and seasonally adjusted, percent change in the level of GDP between 2019Q4 and 2020Q2. \n Regression line excludes value for China.\n Source: Hale, Thomas, Sam Webster, Anna Petherick, Toby Phillips and Beatriz Kira (2020); \nEurostat, OECD, national statistical authorities."))
```


### stringency index vs deviation from IMF October 2019 WEO forecast

```{r}
ggplot(data = df, aes(x = avgH1, y = dev_gdp))+
  geom_point()+
  geom_point(data = filter(df, country %in%  c("Italy", "China", "Sweden", "India", "Germany")),
                   aes(x = avgH1, y = dev_gdp), color = "red")+
  geom_label(data = filter(df, country %in%  c("Italy", "China", "Sweden", "India")),
                   aes(label = country),
                   nudge_x = 1, nudge_y = 1.5, size = 3)+
  geom_label(data = filter(df, country %in%  c("Germany")),
                   aes(label = country),
                   nudge_x = 2, nudge_y = 3, size = 3)+
  scale_x_continuous(limits = c(20, 70), breaks = seq(0, 60, 10))+
  scale_y_continuous(limits = c(-35, 0), breaks = seq(0, -40, -10))+
  labs(x = "index",
       y = "percentage points",
       title = "Lockdown measures and economic activity",
       subtitle = "Average stringency index vs. drop in GDP compared to IMF forecast",
       caption = paste0("Data for ", nrow(df), " advanced and emerging economies.\nStringency index:higher values indicate more stringent lockdown measures,\ndrop in GDP is measured as the difference of 2020H1 growth from the IMF October 2019 WEO forecast. \n Source: Hale, Thomas, Sam Webster, Anna Petherick, Toby Phillips and Beatriz Kira (2020); \nEurostat, OECD, national statistical authorities."))
```

Save figure to png
```{r}
ggsave(
  filename = "plot_H1vsWEO.png",
  plot = last_plot(),
  device = "png",
  path = NULL,
  scale = 1,
  width = 20,
  height = 15,
  units = c("cm")
)
```

## Export data to xlsx

```{r}
library(xlsx)

df_out <- df %>% select(country, avgH1, gdpH1)
write.xlsx(df_out, "data_plot_avgIndex_gdp.xlsx")

df_out <- df %>% select(country, avgH1, gdpH1)
write.xlsx(df_out, "data_plot_avgIndex_gdp_rel_WEO.xlsx")
```


